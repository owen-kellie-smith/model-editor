<?xml version="1.0" encoding="UTF-8"?>

<model id="annuity-model">

  <!-- ===================== -->
  <!-- Units                 -->
  <!-- ===================== -->

  <units>
    <unit id="GBP"/>
    <unit id="GBP_per_year">
      <numerator ref="GBP"/>
      <denominator ref="years"/>
    </unit>
    <unit id="years"/>
    <unit id="probability"/>
  </units>


  <!-- ===================== -->
  <!-- Index sets            -->
  <!-- ===================== -->

  <indexSets>

    <indexSet id="cohort">
      <description>Cohort identifier (model points)</description>
      <dataType>string</dataType>
    </indexSet>

    <indexSet id="age">
      <description>Integer age values (finite domain)</description>
      <dataType>integer</dataType>
    </indexSet>

    <indexSet id="step">
      <description>Projection steps (months)</description>
      <dataType>integer</dataType>
    </indexSet>

  </indexSets>


  <!-- ===================== -->
  <!-- Tables                -->
  <!-- ===================== -->

  <tables>

    <!-- Cohort-level inputs collapsed into one table -->
    <table id="cohort_data">
      <rowIndex ref="cohort"/>
      <columns>
        <column id="initial_age_years" dataType="real" unit="years"/>
        <column id="annuity_start_age_years" dataType="real" unit="years"/>
        <column id="annual_annuity_amount" dataType="real" unit="GBP_per_year"/>
        <column id="mortality_table" dataType="string"/>
      </columns>
    </table>

    <!-- Mortality rates by integer age, multiple tables as columns -->
    <table id="mortality_rate">
      <rowIndex ref="age"/>
      <columns>
        <column id="ELT15" dataType="real" unit="probability"/>
        <column id="AM90" dataType="real" unit="probability"/>
        <column id="PMA90" dataType="real" unit="probability"/>
        <column id="PFA80C_2020" dataType="real" unit="probability"/>
      </columns>
    </table>

  </tables>


  <!-- ===================== -->
  <!-- Variables             -->
  <!-- ===================== -->

  <variables>

    <!-- Base cohort properties -->

    <variable id="initial_age_years">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>real</dataType>
      <unit>years</unit>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="initial_age_years"/>
      </definition>
    </variable>

    <variable id="annuity_start_age_years">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>real</dataType>
      <unit>years</unit>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="annuity_start_age_years"/>
      </definition>
    </variable>

    <variable id="annual_annuity_amount">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>real</dataType>
      <unit>GBP_per_year</unit>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="annual_annuity_amount"/>
      </definition>
    </variable>

    <variable id="mortality_table">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>string</dataType>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="mortality_table"/>
      </definition>
    </variable>


    <!-- Derived time / age variables -->

    <variable id="attained_age_years_floor">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>integer</dataType>
      <unit>years</unit>
      <definition type="expression">
        floor(
          initial_age_years(cohort)
          + step / 12
        )
      </definition>
    </variable>


    <!-- Mortality -->

    <variable id="annual_mortality_rate">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>probability</unit>
      <definition type="tableLookup">
        <table ref="mortality_rate"/>
        <row ref="attained_age_years_floor"/>
        <columnSelector ref="mortality_table"/>
      </definition>
    </variable>

    <variable id="monthly_survival_factor">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>probability</unit>
      <definition type="expression">
        1 - annual_mortality_rate(cohort, step)
      </definition>
    </variable>


    <!-- Benefit payment -->

    <variable id="monthly_benefit">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>GBP</unit>
      <definition type="expression">
        if attained_age_years_floor(cohort, step)
           >= annuity_start_age_years(cohort)
        then
           annual_annuity_amount(cohort) / 12
           * monthly_survival_factor(cohort, step)
        else
           0
      </definition>
    </variable>

  </variables>


  <!-- ===================== -->
  <!-- Outputs               -->
  <!-- ===================== -->

  <outputs>
    <!-- Output requirements defined elsewhere (examples / runs) -->
  </outputs>

</model>
