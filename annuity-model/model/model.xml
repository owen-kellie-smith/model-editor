<?xml version="1.0" encoding="UTF-8"?>

<model id="annuity-model">

  <!-- ===================== -->
  <!-- Index sets            -->
  <!-- ===================== -->

  <indexSets>

    <indexSet id="cohort">
      <description>Cohort identifier (model points)</description>
      <dataType>string</dataType>
    </indexSet>

    <indexSet id="step">
      <description>Projection steps (months)</description>
      <dataType>integer</dataType>
    </indexSet>

    <indexSet id="age">
      <description>Integer age values (finite domain)</description>
      <dataType>integer</dataType>
      <unit>years</unit>
    </indexSet>

  </indexSets>

  <!-- ===================== -->
  <!-- Units                 -->
  <!-- ===================== -->

  <units>

    <unit id="GBP"/>
    <unit id="GBP_per_year"/>
    <unit id="years"/>
    <unit id="months"/>
    <unit id="probability"/>

  </units>

  <!-- ===================== -->
  <!-- Tables                -->
  <!-- ===================== -->

  <tables>

    <!-- Cohort-level inputs collapsed into one table -->
    <table id="cohort_data">
      <rowIndex ref="cohort"/>
      <columns>
        <column id="age_at_valuation" dataType="real" unit="years"/>
        <column id="annuity_start_age" dataType="real" unit="years"/>
        <column id="annual_annuity_amount" dataType="real" unit="GBP_per_year"/>
        <column id="mortality_table" dataType="string"/>
      </columns>
    </table>

    <!-- Mortality rates indexed by integer age -->
    <table id="mortality_rate">
      <rowIndex ref="age"/>
      <columns>
        <!-- unconstrained: column ids supplied by data -->
      </columns>
    </table>

    <!-- Spot rates indexed by projection step -->
    <table id="spot_rate">
      <rowIndex ref="step"/>
      <columns>
        <column id="rate" dataType="real"/>
      </columns>
    </table>

  </tables>

  <!-- ===================== -->
  <!-- Variables              -->
  <!-- ===================== -->

  <variables>

    <!-- Cohort properties -->

    <variable id="age_at_valuation">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>real</dataType>
      <unit>years</unit>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="age_at_valuation"/>
      </definition>
    </variable>

    <variable id="annuity_start_age">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>real</dataType>
      <unit>years</unit>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="annuity_start_age"/>
      </definition>
    </variable>

    <variable id="annual_annuity_amount">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>real</dataType>
      <unit>GBP_per_year</unit>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="annual_annuity_amount"/>
      </definition>
    </variable>

    <variable id="mortality_table">
      <arguments>
        <arg indexSet="cohort"/>
      </arguments>
      <dataType>string</dataType>
      <definition type="table">
        <table ref="cohort_data"/>
        <column ref="mortality_table"/>
      </definition>
      <constraints>
        <mustResolveAs>
          <columnOf table="mortality_rate"/>
        </mustResolveAs>
      </constraints>
    </variable>

    <!-- Derived time variables -->

    <variable id="projection_years">
      <arguments>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>years</unit>
      <definition type="expression">
        step / 12
      </definition>
    </variable>

    <variable id="attained_age">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>years</unit>
      <definition type="expression">
        age_at_valuation(cohort) + projection_years(step)
      </definition>
    </variable>

    <variable id="attained_age_years_floor">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>integer</dataType>
      <unit>years</unit>
      <definition type="expression">
        floor(attained_age(cohort, step))
      </definition>
    </variable>

    <!-- Mortality -->

    <variable id="annual_mortality_rate">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>probability</unit>
      <definition type="tableLookup">
        <table ref="mortality_rate"/>
        <row ref="attained_age_years_floor"/>
        <columnSelector ref="mortality_table"/>
      </definition>
    </variable>

    <variable id="monthly_survival_factor">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>probability</unit>
      <definition type="expression">
        1 - annual_mortality_rate(cohort, step)
      </definition>
    </variable>

    <!-- Benefits -->

    <variable id="is_in_payment">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>boolean</dataType>
      <definition type="expression">
        attained_age(cohort, step) >= annuity_start_age(cohort)
      </definition>
    </variable>

    <variable id="monthly_benefit">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>GBP</unit>
      <definition type="expression">
        is_in_payment(cohort, step)
          ? annual_annuity_amount(cohort) / 12
          : 0
      </definition>
    </variable>

    <!-- Discounting -->

    <variable id="discount_factor">
      <arguments>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <definition type="expression">
        1 / (1 + spot_rate(step)) ^ projection_years(step)
      </definition>
    </variable>

    <variable id="discounted_monthly_benefit">
      <arguments>
        <arg indexSet="cohort"/>
        <arg indexSet="step"/>
      </arguments>
      <dataType>real</dataType>
      <unit>GBP</unit>
      <definition type="expression">
        monthly_benefit(cohort, step) * discount_factor(step)
      </definition>
    </variable>

  </variables>

  <!-- ===================== -->
  <!-- Outputs               -->
  <!-- ===================== -->

  <outputs>
    <!-- Output requirements live elsewhere; this block exists only as a hook -->
  </outputs>

</model>
